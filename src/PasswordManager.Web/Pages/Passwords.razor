@page "/passwords"
@inject PasswordManager.Web.Services.PasswordService PasswordService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager Nav

<h3>Vos Mots de Passe</h3>

@if (passwords == null)
{
    <p>Chargement...</p>
}
else
{
    <ul>
        @foreach (var password in passwords)
        {
            <li>
                <strong>@password.Title</strong> - @password.Username
                <button @onclick="() => DeletePassword(password.Id)">ðŸ—‘ Supprimer</button>
            </li>
        }
    </ul>
}

<h3>Ajouter un mot de passe</h3>
<input @bind="newPassword.Title" placeholder="Nom du site/service" />
<input @bind="newPassword.Username" placeholder="Nom d'utilisateur" />
<input @bind="newPassword.EncryptedPassword" type="password" placeholder="Mot de passe" />
<input @bind="newPassword.Category" placeholder="CatÃ©gorie" />
<button @onclick="AddPassword">Ajouter</button>

@code {
    private List<PasswordManager.Web.Services.PasswordEntry>? passwords;
    private PasswordManager.Web.Services.PasswordEntry newPassword = new()
    {
        CreatedAt = DateTime.UtcNow 
    };

    protected override async Task OnInitializedAsync()
    {
        var token = await localStorage.GetItemAsync<string>("authToken");
        if (string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/login");
            return;
        }

        passwords = await PasswordService.GetPasswords(token);
    }

    private async Task AddPassword()
    {
        var token = await localStorage.GetItemAsync<string>("authToken");
        if (!string.IsNullOrEmpty(token))
        {
            newPassword.CreatedAt = DateTime.UtcNow; 
            await PasswordService.AddPassword(newPassword, token);
            passwords = await PasswordService.GetPasswords(token);
            newPassword = new()
            {
                CreatedAt = DateTime.UtcNow 
            };
        }
    }

    private async Task DeletePassword(int id)
    {
        var token = await localStorage.GetItemAsync<string>("authToken");
        if (!string.IsNullOrEmpty(token))
        {
            await PasswordService.DeletePassword(id, token);
            passwords = await PasswordService.GetPasswords(token);
        }
    }
}

